<!DOCTYPE HTML>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>What's on the radio now</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">  
</head>

    <meta charset="utf-8">
</head>      
<body>


    NOW PLAYING
    <h1 id="nameRadioStation" style = 'position:relative;top:550px;left:0px'>Unknow</h1>
    <p id='description_short' style = 'position:relative;top:600px;left:0px'>Description...</p>
    <p id='lastTrack' style = 'position:relative;top:630px;left:0px'>Last...</p>
    <img src="#" id='lastCover' style = 'position:fixed;top:800px;left:10px;width:100px' alt="">
    <p></p>
    <a id='linkToChannel' href="#" target="_blank">Listening...</a>


 
  
  <script>
    "use strict";

    (async () => {

        function setTimePlay() {
            let nowDate = new Date();
            let start_track = new Date(commits[id_channel].started * 1000);
            let end_track = new Date((commits[id_channel].started + commits[id_channel].duration) * 1000 );

            let time_track = document.createElement('h1');
            time_track.style = 'position:fixed;top:310px;';
            document.body.append(time_track);

            let lastSeconds = Math.floor(nowDate.getTime() / 1000) - commits[id_channel].started;

            let secondsPlay = lastSeconds % 60;
            let minutesPlay = Math.floor(lastSeconds / 60);

            let secondsDuration = commits[id_channel].duration % 60;
            let minutesDuration = Math.floor(commits[id_channel].duration / 60);


            if(secondsPlay < 10) secondsPlay = '0' + secondsPlay;
            if(minutesPlay < 10) minutesPlay = '0' + minutesPlay;
            if(secondsDuration < 10) secondsDuration = '0' + secondsDuration;
            if(minutesDuration < 10) minutesDuration = '0' + minutesDuration;

            time_track.innerHTML = minutesPlay + ':' + secondsPlay + ' / ' + minutesDuration + ':' + secondsDuration; 

            let time_play = document.createElement('p');
            time_play.style = 'position:fixed;top:370px;';
            document.body.append(time_play);

            time_play.innerHTML = start_track.getHours() + ':' + start_track.getMinutes() + ':' 
                + start_track.getSeconds() 
                + ' / ' + 
                + end_track.getHours() + ':' + end_track.getMinutes() + ':' 
                + end_track.getSeconds();
        };

        function setTitleArtist() {
            let nameArtist = commits[id_channel].display_artist;

            let displayArtist = document.createElement('p');
            displayArtist.style = 'position:fixed;top:400px;';
            document.body.append(displayArtist);
            displayArtist.innerHTML = nameArtist;
        }

        function setTitleTrack() {
            let nameArtist = commits[id_channel].display_title;

            let displayTrack = document.createElement('h3');
            displayTrack.style = 'position:fixed;top:430px;';
            document.body.append(displayTrack);
            displayTrack.innerHTML = nameArtist;
        }

        function loadChannelData() {
            let listIdsChannel = [];
            
            for(let i in commits_channel) {
                listIdsChannel.push([i, commits_channel[i]]);
                if(listIdsChannel[i][1].id == id_channel) currentChannel = listIdsChannel[i][1];

            }
            return currentChannel;

        }
        
        
        
        // начало

        let nameRadioStation = ['di', 'radiotunes', 'rockradio', 'zenradio', 'jazzradio', 'classicalradio'];
        let numRadio = Math.floor(Math.random() * 6);
        // let numRadio = 0;
        console.log(nameRadioStation[numRadio])

        const nameSitesRadio = ['https://www.di.fm/', 'https://www.radiotunes.com/', 'https://www.rockradio.com/', 'https://www.zenradio.com/', 'https://www.jazzradio.com/', 'https://www.classicalradio.com/'];

        let url_track = 'http://api.audioaddict.com/v1/' + nameRadioStation[numRadio] + '/track_history.json';
        let url_channel = 'http://api.audioaddict.com/v1/' + nameRadioStation[numRadio] + '/channels.json';
        let response = await fetch(url_track);
        let commits = await response.json(); // читаем текущий трек в формате JSON

        
        // Собираем список всех станций и случайный выбор одной из них
        let listIds = [];
        for(let i in commits)
            listIds.push([i, commits[i]]);
        // let id_channel = 1;
        let id_channel = listIds[Math.floor(Math.random() * listIds.length)][1].channel_id;


        // загружаем json с каналами, делаем список, находим название канала и тд.
        let response_channel = await fetch(url_channel);
        let commits_channel = await response_channel.json();

        // ищем ранее игравшие треки
        let url_last_tracks = 'http://api.audioaddict.com/v1/' + nameRadioStation[numRadio] + '/track_history/channel/' + id_channel + '.json';
         
        let responseLastTracks = await fetch(url_last_tracks);
        let commitsLastTracks = await responseLastTracks.json();

        let numLastImg = 1;
        document.getElementById('lastTrack').innerHTML = commitsLastTracks[numLastImg].title + ' / ' + commitsLastTracks[numLastImg].track;
        document.getElementById('lastCover').src = 'https:' + commitsLastTracks[numLastImg].art_url

        // создаём <img>
        let img = document.createElement('img');
        img.style = 'position:fixed;top:10px;left:10px;width:300px';
        document.body.append(img);

       

        // выводим на экран

        setTimePlay();
        setTitleArtist();
        setTitleTrack(); 
        
        let currentChannel;
        loadChannelData(currentChannel);
        

        document.getElementById('nameRadioStation').innerHTML = currentChannel.name;
        document.getElementById('description_short').innerHTML = currentChannel.description_short;
        document.getElementById('linkToChannel').href = nameSitesRadio[numRadio] + currentChannel.key;


        img.src = 'https:' + commits[id_channel].art_url;

    })()





   

  </script>
    
</body>
</html>